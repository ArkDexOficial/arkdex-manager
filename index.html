<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARKDEX | Pro Manager Cloud</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg: #0b0e11; --card-bg: #161b22; --text-main: #ffffff; --text-dim: #8b949e;
            --primary: #00f2ff; --primary-glow: rgba(0, 242, 255, 0.4);
            --success: #238636; --danger: #da3633; --warning: #fbbf24;
            --border: #30363d; --input-bg: #0d1117;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; text-transform: uppercase; }
        body { background-color: var(--bg); color: var(--text-main); padding: 20px; min-height: 100vh; display: flex; flex-direction: column; }
        .container { max-width: 1100px; margin: auto; width: 100%; flex: 1; }

        header { display: flex; justify-content: center; align-items: center; padding: 20px 0; margin-bottom: 30px; border-bottom: 1px solid var(--border); }
        .logo-area { display: flex; align-items: center; gap: 15px; }
        .logo-icon { background: var(--primary); color: #000; padding: 10px; border-radius: 12px; box-shadow: 0 0 20px var(--primary-glow); }
        .logo-text h1 { font-size: 1.6rem; font-weight: 800; letter-spacing: -1px; line-height: 1; }
        .logo-text h1 span { color: var(--primary); }
        .logo-text p { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 3px; color: var(--text-dim); margin-top: 5px; }

        .wipe-manager { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #1c2128; padding: 10px 20px; border-radius: 12px; border: 1px solid var(--border); }
        .wipe-controls { display: flex; gap: 10px; align-items: center; }
        .btn-wipe-action { padding: 8px 15px; border-radius: 6px; border: none; font-size: 10px; font-weight: 800; cursor: pointer; transition: 0.3s; }
        .btn-new-wipe { background: var(--danger); color: white; }
        .btn-del-wipe { background: #6b1412; color: white; display: none; }
        .select-wipe { background: var(--input-bg); color: white; border: 1px solid var(--border); padding: 5px; border-radius: 4px; font-size: 10px; font-weight: 800; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 16px; border-bottom: 3px solid var(--primary); }
        .stat-label { font-size: 0.65rem; color: var(--text-dim); font-weight: 800; margin-bottom: 5px; display: block; }
        .stat-value { font-size: 1.4rem; font-weight: 800; color: #fff; }

        .form-section { background: var(--card-bg); padding: 25px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 25px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group label.low-case, .search-integrated label.low-case { text-transform: none !important; font-size: 10px; font-weight: 800; color: var(--text-dim); }
        .input-group label:not(.low-case) { font-size: 10px; font-weight: 800; color: var(--text-dim); text-transform: uppercase !important; }
        input::placeholder, textarea::placeholder { text-transform: none !important; }

        input, select, textarea { background: var(--input-bg); border: 1px solid var(--border); color: white; padding: 10px; border-radius: 8px; outline: none; font-size: 12px; transition: 0.2s; }
        input:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(0, 242, 255, 0.1); }

        .btn-main { background: var(--primary); color: #000; font-weight: 800; border: none; padding: 14px; border-radius: 8px; cursor: pointer; margin-top: 20px; width: 100%; transition: 0.3s; }
        .btn-update { background: var(--warning) !important; color: #000 !important; box-shadow: 0 0 15px rgba(251, 191, 36, 0.4); }

        .search-integrated { margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--border); display: flex; flex-direction: column; gap: 5px; }
        .search-integrated input { padding: 14px; font-weight: 600; letter-spacing: 1px; }

        .section-divider { font-size: 10px; font-weight: 800; color: var(--primary); margin: 25px 0 10px 0; display: flex; align-items: center; gap: 10px; }
        .section-divider::after { content: ""; flex: 1; height: 1px; background: var(--border); }

        .vip-card { background: var(--card-bg); border: 1px solid var(--border); border-left: 5px solid var(--primary); border-radius: 12px; padding: 20px; display: grid; grid-template-columns: 2fr 1fr 1fr 1.5fr 1.5fr; align-items: center; gap: 20px; transition: 0.3s; position: relative; }
        .vip-card.baixa { opacity: 0.35; filter: grayscale(1); }
        .vip-card.pausado { border-left-color: var(--warning) !important; background: #1c1912; }

        .info-group { display: flex; flex-direction: column; gap: 4px; }
        .info-label { font-size: 10px; color: var(--text-dim); font-weight: 700; }
        .info-value { font-size: 13px; font-weight: 700; }
        .clickable-id { cursor: pointer; text-decoration: underline; color: var(--primary); transition: 0.2s; }

        .badge { font-size: 9px; padding: 3px 8px; border-radius: 4px; font-weight: 900; display: inline-block; margin-top: 5px; color: #fff; }
        .tag-supremo { background: #f59e0b; color: #000; }
        .tag-elite { background: #0ea5e9; }
        .tag-imperador { background: #8b5cf6; }
        .tag-lendario { background: #ec4899; }
        .tag-extreme { background: #f43f5e; }
        .tag-unloked { background: #64748b; }
        .tag-outros { background: #ffffff; color: #000; }

        .status-badge { padding: 4px 10px; border-radius: 4px; font-size: 9px; font-weight: 800; }
        .color-green { background: #238636; color: #fff; }
        .color-yellow { background: #d29922; color: #fff; }
        .color-red { background: #da3633; color: #fff; }
        .color-outros { background: #3b82f6; color: #fff; }

        .actions { display: flex; gap: 6px; justify-content: flex-end; }
        .btn-action { padding: 8px 10px; border-radius: 6px; border: none; font-size: 9px; font-weight: 800; cursor: pointer; color: #fff; transition: 0.2s; }
        .btn-action:hover { transform: translateY(-2px); filter: brightness(1.2); }
        .btn-edit { background: #0891b2; }
        .btn-pause { background: #d29922; }
        .btn-play { background: #10b981; }
        .btn-baixa { background: #4d7c0f; }
        .btn-restaurar { background: #2563eb; }
        .btn-del { background: #991b1b; }

        .obs-text { font-size: 10px; color: var(--warning); margin-top: 5px; font-style: italic; }

        .modal-overlay { position: fixed; top:0; left:0; width: 100%; height:100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); border: 1px solid var(--primary); border-radius: 16px; width: 90%; max-width: 600px; padding: 25px; position: relative; box-shadow: 0 0 30px rgba(0, 242, 255, 0.2); }
        .confirm-modal { max-width: 400px !important; text-align: center; border-color: var(--danger) !important; }
        .confirm-title { font-size: 1.2rem; font-weight: 800; color: var(--danger); margin-bottom: 15px; }
        .confirm-text { font-size: 0.9rem; color: var(--text-main); margin-bottom: 25px; text-transform: none; }
        .confirm-buttons { display: flex; gap: 10px; justify-content: center; }
        .btn-confirm { padding: 12px 25px; border-radius: 8px; border: none; font-weight: 800; cursor: pointer; font-size: 11px; }
        .btn-yes { background: var(--danger); color: white; }
        .btn-no { background: var(--border); color: white; }
        .modal-close { position: absolute; top: 15px; right: 15px; cursor: pointer; color: var(--text-dim); }
        .modal-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .modal-table th { text-align: left; color: var(--primary); font-size: 10px; padding: 10px; border-bottom: 1px solid var(--border); }
        .modal-table td { padding: 10px; font-size: 11px; border-bottom: 1px solid #21262d; }

		/* RODAPÉ PROFISSIONAL */
        .main-footer {
            margin-top: 50px;
            padding: 30px 0;
            border-top: 1px solid var(--border);
            background: linear-gradient(to top, #0d1117, transparent);
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1100px;
            margin: 0 auto;
            flex-wrap: wrap;
            gap: 20px;
        }

        .footer-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .brand-dot {
            width: 8px; height: 8px;
            background: var(--primary);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--primary-glow);
        }

        .brand-name {
            font-weight: 800;
            font-size: 14px;
            letter-spacing: 1px;
        }

        .v-tag {
            background: #21262d;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            color: var(--text-dim);
        }

        .footer-status {
            font-size: 10px;
            font-weight: 800;
            color: var(--text-dim);
        }

        .status-online {
            color: #238636;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .footer-center {
            text-align: center;
        }

        .footer-center p {
            font-size: 10px;
            font-weight: 800;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .footer-links {
            display: flex;
            gap: 10px;
            justify-content: center;
            font-size: 9px;
            font-weight: 800;
        }

        .footer-links a {
            color: var(--primary);
            text-decoration: none;
            transition: 0.3s;
        }

        .footer-links a:hover { text-shadow: 0 0 8px var(--primary-glow); }

        .sep { color: #30363d; }

        .dev-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 9px;
            font-weight: 800;
            color: var(--text-dim);
            background: #161b22;
            padding: 8px 15px;
            border-radius: 30px;
            border: 1px solid var(--border);
        }

        /* AJUSTE MOBILE */
        @media (max-width: 768px) {
            .footer-content {
                flex-direction: column;
                text-align: center;
            }
            .footer-right { order: -1; }
        }
		/* --- AJUSTE PARA CELULAR (COLE AQUI) --- */
        @media (max-width: 768px) {
            body { padding: 10px; }
            
            /* Ajusta o cabeçalho e gerenciador de wipe */
            .wipe-manager { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 15px;
            }
            .wipe-controls { width: 100%; justify-content: space-between; }
            
            /* Ajusta os cards de estatísticas (2 por linha no celular) */
            .stats-grid { grid-template-columns: 1fr 1fr; }
            
            /* Ajusta o formulário */
            .form-grid { grid-template-columns: 1fr; }
            .form-grid > div { grid-column: span 1 !important; }
            
            /* Ajuste vital para o card de VIP não quebrar */
            .vip-card { 
                grid-template-columns: 1fr !important; 
                gap: 12px !important; 
                padding: 15px !important; 
            }
            
            /* Faz os botões de ação ficarem alinhados embaixo e fáceis de clicar */
            .actions { 
                justify-content: flex-start !important; 
                display: flex; 
                flex-wrap: wrap; 
                gap: 8px; 
                border-top: 1px solid var(--border);
                padding-top: 15px;
                margin-top: 5px;
            }
            .btn-action { 
                flex: 1; 
                min-width: 80px; 
                padding: 12px 5px; 
                font-size: 10px;
            }
        }
		.notification-bar { background: #1c2128; border: 1px solid var(--border); padding: 12px 20px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-left: 4px solid var(--danger); }
        .notif-badge { background: var(--danger); color: white; padding: 2px 8px; border-radius: 20px; font-size: 10px; font-weight: 900; }
        .notif-panel { display: none; background: #161b22; border: 1px solid var(--border); border-radius: 12px; padding: 10px; margin-bottom: 20px; max-height: 300px; overflow-y: auto; }
        .notif-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #30363d; font-size: 11px; }
        .notif-item:last-child { border: none; }
        .notif-urgent { color: var(--danger); font-weight: 800; }
    </style>
</head>
<body>

<div id="confirmModal" class="modal-overlay">
    <div class="modal-content confirm-modal">
        <div class="confirm-title" id="confirmTitle">ATENÇÃO</div>
        <div class="confirm-text" id="confirmText">Deseja realmente realizar esta ação?</div>
        <div class="confirm-buttons">
            <button class="btn-confirm btn-no" onclick="closeConfirm(false)">CANCELAR</button>
            <button class="btn-confirm btn-yes" onclick="closeConfirm(true)">CONFIRMAR</button>
        </div>
    </div>
</div>

<div id="modalDossie" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal()"><i data-lucide="x"></i></span>
        <h2 id="modalPlayerId" style="color: var(--primary); font-size: 1.2rem;">---</h2>
        <p id="modalPlayerTotal" style="font-weight: 800; margin: 10px 0;">TOTAL: R$ 0,00</p>
        <table class="modal-table">
            <thead><tr><th>WIPE</th><th>VIP</th><th>DATA</th><th>VALOR</th></tr></thead>
            <tbody id="modalTableBody"></tbody>
        </table>
    </div>
</div>

<div class="container">
    <header>
        <div class="logo-area">
            <div class="logo-icon"><i data-lucide="shield-check"></i></div>
            <div class="logo-text"><h1>ARK<span>DEX</span></h1><p>Cloud Management System</p></div>
        </div>
    </header>
	<div class="notification-bar" onclick="toggleNotificacoes()" id="notifBar">
        <div style="display: flex; align-items: center; gap: 10px;">
            <i data-lucide="alert-triangle" style="color: var(--danger)"></i>
            <span id="notif-count" class="notif-badge">0</span>
            <span style="font-size: 10px; font-weight: 800;">VIPS VENCIDOS (SISTEMA TOTAL)</span>
        </div>
        <i data-lucide="chevron-down" id="notif-arrow"></i>
    </div>
    <div id="notif-list" class="notif-panel"></div>

    <div class="wipe-manager">
        <div class="info-group">
            <span class="info-label">TEMPORADA / WIPE ATUAL</span>
            <span id="currentWipeName" class="info-value" style="color: var(--primary)">WIPE EM CURSO</span>
        </div>
        <div class="wipe-controls">
            <select id="wipeSelector" class="select-wipe" onchange="changeWipe(this.value)">
                <option value="current">WIPE EM CURSO</option>
            </select>
            <button id="btnFinalize" onclick="finalizeWipe()" class="btn-wipe-action btn-new-wipe">FINALIZAR WIPE</button>
            <button id="btnDelWipe" onclick="deletarWipeHistorico()" class="btn-wipe-action btn-del-wipe">EXCLUIR WIPE</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <span id="wipeStatsLabel" class="stat-label">VENDAS NO WIPE</span>
            <span id="faturamentoAtivo" class="stat-value">R$ 0,00</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">TOTAL DE VIPS</span>
            <span id="totalProtocolos" class="stat-value">0</span>
        </div>
        <div class="stat-card" style="border-bottom-color: var(--success);">
            <span class="stat-label">FATURAMENTO ANUAL</span>
            <span id="faturamentoAnual" class="stat-value">R$ 0,00</span>
        </div>
    </div>

    <div class="form-section" id="formMain">
        <input type="hidden" id="editIndex" value="-1">
        <div class="form-grid">
            <div class="input-group" style="grid-column: span 2;">
                <label class="low-case">Id steam</label>
                <textarea id="idsSteam" placeholder="insira um ou mais ids steam aqui..."></textarea>
            </div>
            <div class="input-group">
                <label>CLASSE VIP</label>
                <select id="tipoVip">
                    <option value="UNLOKED">VIP UNLOKED</option>
                    <option value="ELITE">VIP ELITE</option>
                    <option value="IMPERADOR">VIP IMPERADOR</option>
                    <option value="LENDÁRIO">VIP LENDÁRIO</option>
                    <option value="EXTREME">VIP EXTREME</option>
                    <option value="SUPREMO">VIP SUPREMO</option>
                    <option value="OUTROS">OUTROS</option>
                </select>
            </div>
            <div class="input-group"><label>DATA COMPRA</label><input type="date" id="dataCompra"></div>
            <div class="input-group"><label>VALOR R$</label><input type="number" id="valor" step="0.01" placeholder="0.00"></div>
            <div class="input-group">
                <label class="low-case">Duração (dias)</label>
                <input type="number" id="dias" placeholder="ex: 0 para outros)">
            </div>
            <div class="input-group" style="grid-column: span 6;">
                <label class="low-case">Observações (obs)</label>
                <input type="text" id="obs" placeholder="detalhes adicionais da venda...">
            </div>
        </div>
        <button id="btn-add" onclick="processarVip()" class="btn-main">LANÇA VIP</button>
        <div class="search-integrated">
            <label class="low-case">Pesquisa id steam</label>
            <input type="text" id="inputBusca" placeholder="pesquisar id steam..." onkeyup="render()">
        </div>
    </div>

    <div id="cardsLista" class="cards-container"></div>
</div>

<footer class="main-footer">
    <div class="footer-content">
        <div class="footer-left">
            <div class="footer-brand">
                <span class="brand-dot"></span>
                <span class="brand-name">ARKDEX <span class="v-tag">V1.0</span></span>
            </div>
            <p class="footer-status">Cloud Sync: <span class="status-online">ATIVO</span></p>
        </div>

        <div class="footer-center">
            <p>© 2026 ARKDEX | GESTOR DE VIPS</p>
        </div>

        <div class="footer-right">
            <div class="dev-info">
                <span>DEVELOPED FOR</span>
                <img src="https://img.icons8.com/color/48/ark-survival-evolved.png" alt="ARK" style="width: 20px; height: 20px;">
            </div>
        </div>
    </div>
</footer>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<script>
    // --- 1. CONFIGURAÇÃO FIREBASE (CONEXÃO) ---
    const firebaseConfig = {
        apiKey: "AIzaSyCoObGx8rVkUVdau2zeU2azChGvmmidHcA",
        authDomain: "arkdex-3ce32.firebaseapp.com",
        databaseURL: "https://arkdex-3ce32-default-rtdb.firebaseio.com",
        projectId: "arkdex-3ce32",
        storageBucket: "arkdex-3ce32.appspot.com",
        messagingSenderId: "33403949116",
        appId: "1:33403949116:web:b9e61305ae4b7cf0dd7339"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    lucide.createIcons();
    document.getElementById('dataCompra').valueAsDate = new Date();
    
    // --- 2. VARIÁVEIS GLOBAIS (IGUAIS ÀS SUAS) ---
    let currentVipeList = []; // Começa vazio, Firebase vai preencher
    let wipeHistory = [];     // Começa vazio, Firebase vai preencher
    let selectedWipeIndex = "current";
    let confirmCallback = null;

    const configVip = {
        'UNLOKED': { class: 'tag-unloked', color: '#64748b' },
        'ELITE': { class: 'tag-elite', color: '#0ea5e9' },
        'IMPERADOR': { class: 'tag-imperador', color: '#8b5cf6' },
        'LENDÁRIO': { class: 'tag-lendario', color: '#ec4899' },
        'EXTREME': { class: 'tag-extreme', color: '#f43f5e' },
        'SUPREMO': { class: 'tag-supremo', color: '#f59e0b' },
        'OUTROS': { class: 'tag-outros', color: '#ffffff' }
    };

    // --- 3. SINCRONIZAÇÃO EM TEMPO REAL (O "PULO DO GATO") ---
    // Essa função substitui o JSON.parse do LocalStorage
    db.ref('arkdex_v22').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            currentVipeList = data.current || [];
            wipeHistory = data.history || [];
            updateWipeSelector();
            render(); // Atualiza a tela automaticamente quando algo muda no banco
        }
    });

    /* --- SUAS FUNÇÕES ORIGINAIS (SEM ALTERAÇÃO) --- */
    function toggleNotificacoes() {
        const panel = document.getElementById('notif-list');
        if (panel) panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    }

    function atualizarMonitor() {
        const notifList = document.getElementById('notif-list');
        if (!notifList) return;
        notifList.innerHTML = '';
        let totalVencidos = 0;
        const verificar = (lista, wipeLabel, wipeIdx) => {
            lista.forEach((v, i) => {
                const dVenc = new Date(v.vencimento);
                const diff = dVenc.getTime() - new Date().getTime();
                if (!v.baixado && v.dias > 0 && diff <= 0 && !v.pausado) {
                    totalVencidos++;
                    notifList.innerHTML += `<div class="notif-item"><span style="flex:1">[${wipeLabel}] <b style="color:var(--primary)">${v.ids}</b></span><span class="notif-urgent" style="margin-right:10px">VENCIDO</span><button onclick="editar(${i}, '${wipeIdx}'); toggleNotificacoes();" class="btn-action btn-edit">IR</button></div>`;
                }
            });
        };
        verificar(currentVipeList, "ATUAL", "current");
        wipeHistory.forEach((w, idx) => verificar(w.vips, w.date, idx));
        const countBadge = document.getElementById('notif-count');
        if (countBadge) countBadge.innerText = totalVencidos;
        if (totalVencidos === 0) notifList.innerHTML = '<p style="font-size:10px; padding:10px; color:var(--text-dim); text-align:center;">NENHUM VIP VENCIDO NO SISTEMA.</p>';
    }

    function customConfirm(title, text, callback) {
        document.getElementById('confirmTitle').innerText = title;
        document.getElementById('confirmText').innerText = text;
        document.getElementById('confirmModal').style.display = 'flex';
        confirmCallback = callback;
    }

    function closeConfirm(result) {
        document.getElementById('confirmModal').style.display = 'none';
        if(result && confirmCallback) confirmCallback();
        confirmCallback = null;
    }

    function processarVip() {
        const rawIds = document.getElementById('idsSteam').value.trim();
        const ids = rawIds === "" ? "S / ID" : rawIds;
        const tipo = document.getElementById('tipoVip').value;
        const dataCompra = document.getElementById('dataCompra').value;
        const valor = parseFloat(document.getElementById('valor').value) || 0;
        const dias = parseInt(document.getElementById('dias').value) || 0;
        const obs = document.getElementById('obs').value;
        const index = parseInt(document.getElementById('editIndex').value);
        if (!dataCompra) return alert("PREENCHA A DATA!");
        const dVenc = new Date(dataCompra + 'T00:00:00');
        dVenc.setDate(dVenc.getDate() + dias);
        const dados = { ids, tipo, dataCompra, valor, vencimento: dVenc.toISOString(), dias, obs, pausado: false, tempoRestanteAoPausar: null, baixado: false };
        let targetList = (selectedWipeIndex === "current") ? currentVipeList : wipeHistory[selectedWipeIndex].vips;
        if (index === -1) targetList.unshift(dados);
        else { targetList[index] = { ...targetList[index], ...dados }; document.getElementById('editIndex').value = "-1"; }
        salvarGeral();
    }

    function render() {
        atualizarMonitor();
        const lista = document.getElementById('cardsLista');
        const busca = document.getElementById('inputBusca').value.toUpperCase();
        lista.innerHTML = '';
        let fWipeVisualizado = 0;
        let fAnualTotal = 0;
        wipeHistory.forEach(w => w.vips.forEach(v => fAnualTotal += v.valor));
        currentVipeList.forEach(v => fAnualTotal += v.valor);
        const listExibida = (selectedWipeIndex === "current") ? currentVipeList : wipeHistory[selectedWipeIndex].vips;
        listExibida.forEach(v => fWipeVisualizado += v.valor);

	const createCard = (v, i, isFromSearchHist = false, wHistIndex = -1, wDate = "") => {
		const dVenc = new Date(v.vencimento);
		const agora = new Date();
		agora.setHours(0, 0, 0, 0);
		const vencZero = new Date(v.vencimento);
		vencZero.setHours(0, 0, 0, 0);
		
		let diffDias;
		if (v.pausado) {
		    diffDias = v.tempoRestanteAoPausar;
		} else {
		    let diffMs = vencZero.getTime() - agora.getTime();
		    diffDias = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
		}
	    
	    let corClasse = (diffDias <= 3) ? 'color-red' : (diffDias <= 5) ? 'color-yellow' : 'color-green';
	    let statusHTML = (v.tipo === 'OUTROS' && v.dias === 0) ? `<span class="status-badge color-outros">ITENS / PONTOS</span>` : 
	                     (v.pausado) ? `<span class="status-badge color-yellow">PAUSADO - RESTA ${diffDias} DIAS</span>` :
	                     (v.baixado) ? `<span class="status-badge" style="background:#555">CONCLUÍDO (BAIXA)</span>` :
	                     (diffDias <= 0) ? `<span class="status-badge color-red">VENCIDO</span>` : `<span class="status-badge ${corClasse}">ATIVO - ${diffDias} DIAS</span>`;
	
	    let listIdx = isFromSearchHist ? wHistIndex : selectedWipeIndex;
	
	    const idsSeparados = v.ids.split(/[,/ ]+/).filter(id => id.trim() !== "");
	    const idsHTML = idsSeparados.map(id => 
	        `<span class="clickable-id" onclick="showPlayerInfo('${id.trim()}')">${id.trim()}</span>`
	    ).join(', ');

	    return `<div class="vip-card ${v.pausado ? 'pausado' : ''} ${v.baixado ? 'baixa' : ''}" style="border-left-color: ${configVip[v.tipo].color}">
	        <div class="info-group">
	            <span class="info-label">ID STEAM ${wDate ? `[WIPE ${wDate}]` : ''}</span>
	            <span class="info-value">${idsHTML}</span> <div><span class="badge ${configVip[v.tipo].class}">${v.tipo}</span></div>
	            ${v.obs ? `<div class="obs-text">OBS: ${v.obs}</div>` : ''}
	        </div>
	        <div class="info-group"><span class="info-label">VALOR</span><span class="info-value" style="color:var(--primary)">R$ ${v.valor.toFixed(2)}</span></div>
	        <div class="info-group"><span class="info-label">COMPRA</span><span class="info-value">${new Date(v.dataCompra + 'T00:00:00').toLocaleDateString('pt-BR')}</span></div>
	        <div class="info-group"><span class="info-label">VENCIMENTO</span><span class="info-value">${(v.pausado || (v.tipo === 'OUTROS' && v.dias === 0)) ? '---' : dVenc.toLocaleDateString('pt-BR')}</span><div style="margin-top:5px">${statusHTML}</div></div>
	        <div class="actions">
	            ${!v.baixado ? `<button onclick="editar(${i}, '${listIdx}')" class="btn-action btn-edit">EDITAR</button>` : ''}
	            ${(v.tipo === 'OUTROS' && v.dias === 0) || v.baixado ? '' : `<button onclick="togglePausa(${i}, '${listIdx}')" class="btn-action ${v.pausado ? 'btn-play' : 'btn-pause'}">${v.pausado ? 'RETOMAR' : 'PAUSAR'}</button>`}
	            ${v.baixado ? `<button onclick="restaurarBaixa(${i}, '${listIdx}')" class="btn-action btn-restaurar">RESTAURAR</button>` : `<button onclick="darBaixa(${i}, '${listIdx}')" class="btn-action btn-baixa">BAIXA</button>`}
	            <button onclick="deletar(${i}, '${listIdx}')" class="btn-action btn-del">DELETAR</button>
	        </div>
	    </div>`;
	};

	if (busca !== "") {
            lista.innerHTML += `<div class="section-divider">NO WIPE SELECIONADO</div>`;
            // Percorre a lista normalmente (O mais novo já é o primeiro)
            listExibida.forEach((v, i) => { 
                if(v.ids.toUpperCase().includes(busca)) {
                    lista.innerHTML += createCard(v, i); 
                }
            });

            lista.innerHTML += `<div class="section-divider">OUTROS WIPES</div>`;
            if(selectedWipeIndex !== "current") { 
                currentVipeList.forEach((v, i) => { 
                    if(v.ids.toUpperCase().includes(busca)) {
                        lista.innerHTML += createCard(v, i, false, "current", "ATUAL"); 
                    }
                }); 
            }

            // Histórico de wipes (Wipes antigos)
            [...wipeHistory].reverse().forEach((w, revWIdx) => { 
                const wIdx = wipeHistory.length - 1 - revWIdx; 
                if(selectedWipeIndex != wIdx) { 
                    w.vips.forEach((v, i) => { 
                        if(v.ids.toUpperCase().includes(busca)) {
                            lista.innerHTML += createCard(v, i, true, wIdx, w.date); 
                        }
                    }); 
                } 
            });
        } else {
            // MOSTRAR TUDO: Sem reverse, pois o unshift já colocou o novo no topo
            listExibida.forEach((v, i) => { 
                lista.innerHTML += createCard(v, i); 
            });
        }

        document.getElementById('faturamentoAtivo').innerText = `R$ ${fWipeVisualizado.toFixed(2)}`;
        document.getElementById('totalProtocolos').innerText = listExibida.length;
        document.getElementById('faturamentoAnual').innerText = `R$ ${fAnualTotal.toFixed(2)}`;
        document.getElementById('wipeStatsLabel').innerText = (selectedWipeIndex === "current") ? "VENDAS NO WIPE" : "VENDAS NESTE ARQUIVO";
        lucide.createIcons();
	}

	function togglePausa(index, wipeIdx) {
	    let list = (wipeIdx === "current") ? currentVipeList : wipeHistory[wipeIdx].vips;
	    const v = list[index];
	    
	    const hoje = new Date();
	    hoje.setHours(0, 0, 0, 0);
	
	    if (!v.pausado) {
	        const vencimento = new Date(v.vencimento);
	        vencimento.setHours(0, 0, 0, 0);
	
	        const diffMs = vencimento.getTime() - hoje.getTime();
	        let diasRestantes = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
	
	        v.tempoRestanteAoPausar = diasRestantes < 0 ? 0 : diasRestantes;
	        v.pausado = true;
	    } else {
	        const novaDataVencimento = new Date();
	        novaDataVencimento.setHours(0, 0, 0, 0);
	        novaDataVencimento.setDate(novaDataVencimento.getDate() + v.tempoRestanteAoPausar);
	
	        v.vencimento = novaDataVencimento.toISOString();
	        v.pausado = false;
	        v.tempoRestanteAoPausar = null;
	    }
	
	    salvarGeral();
	}

    function darBaixa(index, wipeIdx) { 
        customConfirm("DAR BAIXA", "Marcar como concluído?", () => {
            let list = (wipeIdx === "current") ? currentVipeList : wipeHistory[wipeIdx].vips;
            list[index].baixado = true; 
            salvarGeral();
        });
    }

    function restaurarBaixa(index, wipeIdx) {
        customConfirm("RESTAURAR", "Remover a baixa?", () => {
            let list = (wipeIdx === "current") ? currentVipeList : wipeHistory[wipeIdx].vips;
            list[index].baixado = false; 
            salvarGeral();
        });
    }
    
    function editar(index, wipeIdx) {
        if(wipeIdx !== selectedWipeIndex) { changeWipe(wipeIdx); document.getElementById('wipeSelector').value = wipeIdx; }
        let list = (wipeIdx === "current") ? currentVipeList : wipeHistory[wipeIdx].vips;
        const v = list[index];
        document.getElementById('idsSteam').value = v.ids === "S / ID" ? "" : v.ids;
        document.getElementById('tipoVip').value = v.tipo;
        document.getElementById('dataCompra').value = v.dataCompra;
        document.getElementById('valor').value = v.valor;
        document.getElementById('dias').value = v.dias;
        document.getElementById('obs').value = v.obs;
        document.getElementById('editIndex').value = index;
        const btn = document.getElementById('btn-add');
        btn.innerText = "ATUALIZAR REGISTRO"; btn.classList.add('btn-update');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deletar(index, wipeIdx) { 
        customConfirm("EXCLUIR", "Deseja apagar permanentemente?", () => {
            let list = (wipeIdx === "current") ? currentVipeList : wipeHistory[wipeIdx].vips;
            list.splice(index, 1); 
            salvarGeral();
        });
    }

	function showPlayerInfo(steamId) {
		if(!steamId || steamId === "S / ID") return;
		
		let total = 0, html = '';
		// O ID que você clicou (limpo e em maiúsculo)
		const buscarId = steamId.trim().toUpperCase(); 

		const search = (list, label) => {
			list.forEach(v => {
				const idsArray = v.ids.toUpperCase().split(/[,/ ]+/).map(item => item.trim());
				if(idsArray.includes(buscarId)) {
					total += v.valor;
					const dataFormatada = new Date(v.dataCompra + 'T12:00:00').toLocaleDateString('pt-BR');
					
					html += `<tr>
								<td>${label}</td>
								<td>${v.tipo}</td>
								<td>${dataFormatada}</td>
								<td>R$ ${v.valor.toFixed(2)}</td>
							 </tr>`;
				}
			});
		};

		search(currentVipeList, "ATUAL");
		wipeHistory.forEach(w => search(w.vips, w.date));

		document.getElementById('modalPlayerId').innerText = "HISTÓRICO DO ID: " + buscarId;
		document.getElementById('modalPlayerTotal').innerText = "INVESTIMENTO TOTAL: R$ " + total.toFixed(2);
		document.getElementById('modalTableBody').innerHTML = html || '<tr><td colspan="4" style="text-align:center">NENHUM REGISTRO ENCONTRADO</td></tr>';
		
		document.getElementById('modalDossie').style.display = 'flex';
	}

    function closeModal() { document.getElementById('modalDossie').style.display = 'none'; }

    function finalizeWipe() {
        if(currentVipeList.length === 0) return;
        customConfirm("FINALIZAR WIPE", "Deseja realmente arquivar este wipe?", () => {
            wipeHistory.push({ date: new Date().toLocaleDateString('pt-BR'), vips: [...currentVipeList] });
            currentVipeList = [];
            salvarGeral();
            updateWipeSelector();
        });
    }

    function deletarWipeHistorico() {
        if(selectedWipeIndex === "current") return;
        customConfirm("EXCLUIR WIPE", "Tem certeza que deseja apagar este WIPE do histórico?", () => {
            wipeHistory.splice(selectedWipeIndex, 1);
            selectedWipeIndex = "current";
            salvarGeral();
            updateWipeSelector();
            changeWipe("current");
        });
    }

    function changeWipe(val) {
        selectedWipeIndex = val;
        document.getElementById('btnFinalize').style.display = (val === "current") ? "block" : "none";
        document.getElementById('btnDelWipe').style.display = (val === "current") ? "none" : "block";
        const label = document.getElementById('currentWipeName');
        if (label) label.innerText = (val === "current") ? "WIPE EM CURSO" : "ARQUIVO: " + wipeHistory[val].date;
        limpar();
        render();
    }

    function updateWipeSelector() {
        const sel = document.getElementById('wipeSelector');
        if(!sel) return;
        sel.innerHTML = '<option value="current">WIPE EM CURSO</option>';
        wipeHistory.forEach((h, i) => { sel.innerHTML += `<option value="${i}">WIPE - ${h.date}</option>`; });
        sel.value = selectedWipeIndex;
    }

    // --- 4. FUNÇÃO SALVAR (ALTERADA PARA FIREBASE) ---
    function salvarGeral() { 
        // Em vez de LocalStorage, enviamos para a nuvem
        db.ref('arkdex_v22').set({
            current: currentVipeList,
            history: wipeHistory
        });
        limpar(); 
    }

    function limpar() { 
        document.getElementById('idsSteam').value = ''; 
        document.getElementById('valor').value = ''; 
        document.getElementById('dias').value = ''; 
        document.getElementById('obs').value = ''; 
        document.getElementById('dataCompra').valueAsDate = new Date(); 
        const btn = document.getElementById('btn-add');
        btn.innerText = "LANÇA VIP"; btn.classList.remove('btn-update');
        document.getElementById('editIndex').value = "-1"; 
    }
</script>
</body>
</html>




